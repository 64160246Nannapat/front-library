<template>
  <v-main style="height: 500px; margin-top: -90px">
    <v-main>
      <v-container>
        <div class="header" style="margin-bottom: 20px">
          <img class="header-image" src="@/assets/library (1).png" alt="Library Image" />
          <h1>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏ô‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</h1>
        </div>
        <v-form ref="bookForm" v-model="valid" class="form-wrapper">
          <!-- ‡πÉ‡∏ä‡πâ Grid Layout ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏° -->
          <div class="form-grid">
            <!--‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠-->
            <v-row class="form-row pa-0 mt-n3">
              <v-col cols="12" md="6" class="mb-1">
                <!-- ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• -->
                <label for="name" style="font-size: 17px; margin-bottom: 4px">
                  ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•<span class="required-asterisk">*</span>
                </label>
                <v-text-field
                  v-model="fullName"
                  :rules="[rules.required]"
                  variant="outlined"
                  class="text-feild-top text gray-field"
                  dense
                  style="margin-top: 0"
                ></v-text-field>
              </v-col>

              <v-col cols="12" md="6" class="mb-1">
                <!-- ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á -->
                <label for="role" style="font-size: 17px; margin-bottom: 4px">
                  ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á<span class="required-asterisk">*</span>
                </label>
                <v-text-field
                  v-model="book.Role"
                  :rules="[rules.required]"
                  variant="outlined"
                  class="text-feild-top text gray-field"
                  dense
                  style="margin-top: 0"
                ></v-text-field>
              </v-col>
            </v-row>

            <v-row class="form-row pa-0 mt-n3">
              <v-col cols="12" md="6" class="mb-1">
                <!-- ‡∏Ñ‡∏ì‡∏∞ -->
                <label for="faculty" style="font-size: 17px; margin-bottom: 4px">
                  ‡∏Ñ‡∏ì‡∏∞<span class="required-asterisk">*</span>
                </label>
                <v-text-field
                  v-model="book.Faculty"
                  :items="faculties"
                  :rules="[rules.required]"
                  variant="outlined"
                  class="text-feild-top text gray-field"
                  dense
                  style="margin-top: 0"
                ></v-text-field>
              </v-col>

              <v-col cols="12" md="6" class="mb-1">
                <!-- ‡∏™‡∏≤‡∏Ç‡∏≤ -->
                <label for="department" style="font-size: 17px; margin-bottom: 4px">
                  ‡∏™‡∏≤‡∏Ç‡∏≤<span class="required-asterisk">*</span>
                </label>
                <v-text-field
                  v-model="book.Department"
                  :items="departments"
                  :rules="[rules.required]"
                  variant="outlined"
                  class="text-feild-top text gray-field"
                  dense
                  style="margin-top: 0"
                ></v-text-field>
              </v-col>
            </v-row>

            <v-row class="form-row pa-0 mt-n3">
              <v-col cols="12" md="6" class="mb-1">
                <!-- ‡πÄ‡∏ö‡∏≠‡∏£‡πå -->
                <label for="tel" style="font-size: 17px; margin-bottom: 4px">
                  ‡πÄ‡∏ö‡∏≠‡∏£‡πå<span class="required-asterisk">*</span>
                </label>
                <v-text-field
                  v-model="book.Tel"
                  :rules="[rules.required, rules.tel]"
                  variant="outlined"
                  class="text-feild-top text gray-field"
                  dense
                  style="margin-top: 0"
                ></v-text-field>
              </v-col>

              <v-col cols="12" md="6" class="mb-1">
                <!-- E-mail -->
                <label for="email" style="font-size: 17px; margin-bottom: 4px">
                  E-mail<span class="required-asterisk">*</span>
                </label>
                <v-text-field
                  v-model="book.Email"
                  :rules="[rules.required, rules.email]"
                  variant="outlined"
                  class="text-feild-top text gray-field"
                  dense
                  style="margin-top: 0"
                ></v-text-field>
              </v-col>
            </v-row>

            <!--‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠-->
            <v-row class="form-row align-center pa-0">
              <v-col cols="12" md="12" class="mb-1">
                <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ -->
                <label for="title" style="font-size: 17px">
                  ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠<span class="required-asterisk">*</span>
                </label>
                <v-text-field
                  v-model="book.Title"
                  :rules="[rules.required]"
                  variant="outlined"
                  class="custom-input"
                  dense
                ></v-text-field>
              </v-col>
            </v-row>

            <v-row class="form-row pa-0 mt-n3">
              <!-- ‡∏•‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ -->
              <!-- ‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á -->
              <v-col cols="12" md="12" class="mb-1">
                <label for="author" style="font-size: 17px">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á</label>
                <v-text-field
                  v-model="book.Author"
                  variant="outlined"
                  class="text-feild-top"
                  dense
                ></v-text-field>
              </v-col>
            </v-row>

            <v-row class="form-row pa-0 mt-n3">
              <!-- ‡∏•‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á -->
              <v-col cols="12" md="6" class="mb-1">
                <!-- ISBN -->
                <label for="isbn" style="font-size: 17px">
                  ISBN<span class="required-asterisk">*</span>
                </label>
                <v-text-field
                  v-model="book.isbn"
                  :rules="[rules.required]"
                  variant="outlined"
                  class="text-feild-top"
                  dense
                ></v-text-field>
              </v-col>

              <v-col cols="12" md="6" class="mb-1">
                <!-- ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ -->
                <label for="Course" style="font-size: 17px"> ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ </label>
                <v-text-field
                  v-model="book.Course"
                  variant="outlined"
                  class="text-feild-top"
                  dense
                ></v-text-field>
              </v-col>
            </v-row>

            <v-row class="form-row pa-0 mt-n3">
              <!-- ‡∏•‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ -->
              <!-- detail -->
              <v-col cols="12" md="12" class="mb-1">
                <label for="detail" style="font-size: 17px">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                <v-textarea
                  v-model="book.Details"
                  variant="outlined"
                  class="text-feild-top"
                  dense
                  :style="{ width: '100%', minHeight: '100px' }"
                  rows="4"
                ></v-textarea>

                <v-card-text style="font-size: 14px; color: gray; margin-top: -5px; padding-top: 0">
                  (ex. ‡∏ú‡∏π‡πâ‡πÅ‡∏õ‡∏• ‡∏ì‡∏±‡∏ê‡∏Å‡∏§‡∏ï‡∏≤ ‡πÄ‡∏û‡πá‡∏ç‡∏Å‡∏∏‡∏•, ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏û‡∏¥‡∏°‡∏û‡πå ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø : ‡∏ß‡∏µ‡πÄ‡∏•‡∏¥‡∏£‡πå‡∏ô, ‡∏õ‡∏µ‡∏û‡∏¥‡∏°‡∏û‡πå 2566,
                  ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1, 137 ‡∏´‡∏ô‡πâ‡∏≤ : ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö ; 21 ‡∏ã‡∏°)
                </v-card-text>
              </v-col>
            </v-row>

            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô -->
            <v-btn
              :disabled="!valid"
              elevation="8"
              class="mt-4 confirm-btn confirm-btnheight"
              style="background-color: #c39898"
              @click="submitForm"
            >
              ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            </v-btn>
          </div>
        </v-form>
        <!-- dialog ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•-->
        <v-dialog v-model="dialog" max-width="500px">
          <v-card class="dialog" style="background-color: #ede8dc">
            <v-card-title
              class="text-start"
              style="
                font-weight: bold;
                background-color: #c39898;
                padding: 16px;
                border-top-left-radius: 0px;
                border-top-right-radius: 0px;
                border-bottom-left-radius: 16px;
                border-bottom-right-radius: 16px;
                font-size: 20px;
              "
            >
              {{ isDuplicate ? '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô' : '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°' }}
            </v-card-title>

            <v-card-text class="text-start" style="font-size: 14px; color: #808080">
              <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ -->
              <div>
                <div>‡∏ä‡∏∑‡πà‡∏≠: {{ book.FirstName }} {{ book.LastName }}</div>
                <div>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: {{ book.Role }}</div>
                <div>‡∏Ñ‡∏ì‡∏∞: {{ book.Faculty }}</div>
                <div>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠: {{ book.Title }}</div>
                <div>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á: {{ book.Author }}</div>
                <div>ISBN: {{ book.isbn }}</div>
                <div>‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤: {{ book.Course || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</div>
                <div>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: {{ book.Count }} ‡πÄ‡∏•‡πà‡∏°</div>
                <div>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: {{ book.Details || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î' }}</div>
              </div>
              <v-divider v-if="isDuplicate" class="my-4" style="color: black"></v-divider>
              <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏´‡∏≤‡∏Å‡∏û‡∏ö ISBN ‡∏ã‡πâ‡∏≥ -->
              <div v-if="isDuplicate" style="color: red; font-weight: bold; margin-top: 16px">
                {{ confirmMessage }}
              </div>
            </v-card-text>

            <v-card-actions justify="start">
              <v-btn
                color="black"
                @click="cancelForm"
                style="
                  font-weight: bold;
                  border: 2px;
                  border-radius: 8px;
                  background-color: #fa8072;
                  margin-bottom: 8px;
                "
              >
                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
              </v-btn>

              <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° -->
              <v-btn
                color="black"
                @click="confirmForm"
                style="
                  font-weight: bold;
                  border: 2px;
                  border-radius: 8px;
                  background-color: #58d68d;
                  margin-bottom: 8px;
                "
              >
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
              </v-btn>
            </v-card-actions>
          </v-card>
        </v-dialog>

        <!-- dialog ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à-->
        <v-dialog
          v-model="successdialog"
          max-width="300px"
          persistent
          center
          @click:outside="successdialog = false"
        >
          <v-card class="dialog" style="background-color: #ede8dc; border-radius: 50px">
            <v-card-text
              class="text-center"
              style="font-size: 24px; font-weight: bold; color: #808080; padding: 20px"
            >
              <img
                src="@/assets/check.png"
                alt="Check"
                style="width: 80px; height: 80px; margin-bottom: 20px"
              />

              <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô -->
              <div>‡πÄ‡∏™‡∏ô‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
            </v-card-text>
          </v-card>
        </v-dialog>
      </v-container>
    </v-main>
  </v-main>
</template>

<script setup lang="ts">
import axios from 'axios'
import { onMounted, ref, computed } from 'vue'
import { jwtDecode } from 'jwt-decode'
import type { VForm } from 'vuetify/components'

const bookForm = ref<VForm | null>(null)
const submitted = ref(false)
const valid = ref(false) //‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö v-form
const dialog = ref(false)
const successdialog = ref(false)
const isDuplicate = ref(false)
const disableValidation = ref(false)
const confirmMessage = ref('')

const fullName = computed(() => {
  return `${book.value.Prefix || ''} ${book.value.FirstName || ''} ${book.value.LastName || ''}`.trim()
})

const book = ref({
  Prefix: '',
  FirstName: '',
  LastName: '',
  Role: '',
  Faculty: '',
  Department: '',
  Tel: '',
  Email: '',
  Title: '',
  Author: '',
  Year: '',
  isbn: '',
  Course: '',
  User: '',
  Details: '',
})

const user = ref({
  Prefix: '',
  FirstName: '',
  LastName: '',
  Role: '',
  Faculty: '',
  Department: '',
  Tel: '',
  Email: '',
  User: '',
})

const rules = {
  required: (value: string) => {
    if (disableValidation.value) return true // ‡∏õ‡∏¥‡∏î validation
    return value ? true : '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
  },
  email: (value: string) =>
    /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(value) || '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
  tel: (value: string) => /^[0-9]{9,10}$/.test(value) || '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 9 - 10 ‡∏´‡∏•‡∏±‡∏Å',
  isbn: (value: string) => /^(97(8|9))?\d{9}(\d|X)$/.test(value) || '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ISBN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
  number: (value: string | null) => {
    if (value === null || value === undefined || value === '') {
      return true // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á alert
    }
    return /^[0-9]+(\.[0-9]+)?$/.test(value) || '‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô'
  },
  radio: (value) => !!value || '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å',
}

const fetchUserData = async () => {
  const token = localStorage.getItem('token')

  if (!token) {
    alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà')
    window.location.href = '/'
    return
  }

  try {
    let userId = null
    const decoded: any = isTokenExpired(token) ? await refreshAndDecodeToken() : jwtDecode(token)

    if (!decoded || !decoded.sub) {
      console.error('‚ùå Token decoding failed or userId not found!')
      alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà')
      return
    }

    userId = decoded.sub

    let userData = {}
    switch (decoded.role) {
      case 'Student':
        userData = decoded.student || {}
        break
      case 'Admin':
        userData = decoded.admin || {}
        break
      case 'Teacher':
        userData = decoded.teacher || {}
        break
      case 'StaffLibrary':
        userData = decoded.staffLibrary || {}
        break
      case 'Executive':
        userData = decoded.executive || {}
        break
      case 'StaffFaculty':
        userData = decoded.staffFaculty || {}
        break
      default:
        console.warn('‚ö†Ô∏è Unknown role:', decoded.role)
    }

    if (!userData || Object.keys(userData).length === 0) {
      console.error('‚ùå No user data available for the role:', decoded.role)
      return
    }

    user.value = {
      Prefix: userData.user_prefix || '-',
      FirstName: userData.user_firstName || '-',
      LastName: userData.user_lastName || '-',
      Role: userData.duty_name || '-',
      Faculty: userData.faculty_name || '-',
      Department: userData.department_name || '-',
      Tel: decoded.tel || '-',
      Email: decoded.email || '-',
      User: userId,
    }

    console.log('‚úÖ User Data:', user.value)

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï book.value ‡∏à‡∏≤‡∏Å user.value
    Object.assign(book.value, user.value)
    console.log('üìå Book Updated:', book.value)
  } catch (error) {
    console.error('‚ùå Token decoding error:', error)
  }
}

const confirmForm = async (bookForm: any) => {
  try {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ userId ‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
    const userId = book.value.User || user.value.User
    if (!userId) {
      console.error('‚ùå User ID is null! Cannot proceed.')
      alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà')
      await fetchUserData() // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà
      return
    }

    const bookQuantity = book.value.Count ? Number(book.value.Count) : 1
    const bookPrice = book.value.Price ? Number(book.value.Price) : 0

    const formData = {
      user_name: `${book.value.Prefix} ${book.value.FirstName} ${book.value.LastName}`.trim(),
      user_email: book.value.Email || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•',
      user_tel: book.value.Tel || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£',
      book_title: book.value.Title,
      book_author: book.value.Author,
      book_course: book.value.Course || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
      book_category: '‡πÄ‡∏™‡∏ô‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
      ISBN: book.value.isbn || '',
      book_price: bookPrice || 0,
      book_quantity: bookQuantity || 0,
      user_id: userId,
      coupon_used: book.value.Coupon || false,
      form_description: book.value.Details || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î',
    }

    console.log('‚úÖ Form Data:', formData)

    const token = localStorage.getItem('token')
    if (!token) {
      throw new Error('‚ùå Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏')
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
    const oldUserData = await axios.get(`http://bookfair.buu.in.th:8043/users/${userId}`, {
      headers: { Authorization: `Bearer ${token}` },
    })

    const oldUser = oldUserData.data

    if (book.value.Tel !== oldUser.user_tel || book.value.Email !== oldUser.user_email) {
      await axios.patch(
        `http://bookfair.buu.in.th:8043/users/${userId}`,
        {
          user_email: book.value.Email,
          user_tel: book.value.Tel,
        },
        {
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
        },
      )
      console.log('‚úÖ User data updated successfully')
    }

    const response = await axios.post('http://bookfair.buu.in.th:8043/offer-forms-onl', formData, {
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
    })

    console.log('‚úÖ Response:', response.data)
    submitted.value = true
    dialog.value = false
    successdialog.value = true

    await fetchUserData() // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà
    resetForm(bookForm)
  } catch (error) {
    console.error('‚ùå Error submitting form:', error)
    if (error.response) {
      console.error('üö® API Error Details:', error.response.data)
    }
  }
}

const submitForm = async () => {
  const form = bookForm.value
  if (form && typeof form.validate === 'function') {
    const { valid } = await form.validate()

    if (valid) {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ book.Count ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô 1
      if (!book.value.Count) {
        book.value.Count = 1
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ISBN ‡∏ã‡πâ‡∏≥
      const duplicate = await checkDuplicateISBN(book.value.isbn)
      isDuplicate.value = duplicate

      if (duplicate) {
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        confirmMessage.value = `"${book.value.Title}" ‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡πÄ‡∏™‡∏ô‡∏≠‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`
      } else {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
        confirmMessage.value = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°'
      }

      dialog.value = true // ‡πÅ‡∏™‡∏î‡∏á dialog
    } else {
      console.log('Validation Failed')
    }
  } else {
    console.error('Form reference is invalid or validate is not a function')
  }
}

const checkDuplicateISBN = async (isbn) => {
  try {
    const response = await axios.get(`http://bookfair.buu.in.th:8043/offer-forms-onl?isbn=${isbn}`)
    console.log('API Response:', response.data)

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ response.data ‡πÄ‡∏õ‡πá‡∏ô array ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á
    if (Array.isArray(response.data) && response.data.length > 0) {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ISBN ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      for (let offer of response.data) {
        if (offer.ISBN === isbn) {
          return true // ISBN ‡∏ã‡πâ‡∏≥
        }
      }
    }

    return false // ‡πÑ‡∏°‡πà‡∏°‡∏µ ISBN ‡∏ã‡πâ‡∏≥
  } catch (error) {
    console.error('Error checking duplicate ISBN:', error)
    return false // ‡∏´‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ISBN ‡∏ã‡πâ‡∏≥
  }
}

const refreshAndDecodeToken = async () => {
  try {
    const newAccessToken = await refreshToken()
    return jwtDecode(newAccessToken)
  } catch (error) {
    console.error('Error refreshing token:', error)
    return null
  }
}

const cancelForm = () => {
  dialog.value = false // ‡∏õ‡∏¥‡∏î dialog
}

const resetForm = (bookForm: any) => {
  // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°
  const { Prefix, FirstName, LastName, Role, Faculty, Department, Tel, Email } = book.value

  // ‡∏õ‡∏¥‡∏î validation ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
  disableValidation.value = true

  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
  book.value = {
    Prefix,
    FirstName,
    LastName,
    Role,
    Faculty,
    Department,
    Tel,
    Email,
    Title: '',
    Author: '',
    Year: '',
    isbn: '',
    Course: '',
    Count: null,
  }

  // ‡πÄ‡∏õ‡∏¥‡∏î validation ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
  setTimeout(() => {
    disableValidation.value = false
  }, 0)

  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï validation (‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° alert validation)
  bookForm.resetValidation() // ‡πÉ‡∏ä‡πâ bookForm ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å resetValidation

  submitted.value = false // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
}

const isTokenExpired = (token: string) => {
  const decoded: any = jwtDecode(token)
  const currentTime = Date.now() / 1000 // Convert to seconds
  return decoded.exp < currentTime // Compare expiration time
}

const refreshToken = async () => {
  const refreshToken = localStorage.getItem('refresh_token')
  if (refreshToken) {
    try {
      const response = await axios.post('http://bookfair.buu.in.th:8044/auth/refresh', {
        refreshToken,
      })
      const { access_token, refresh_token } = response.data
      // ‡πÄ‡∏Å‡πá‡∏ö Access Token ‡πÅ‡∏•‡∏∞ Refresh Token ‡πÉ‡∏´‡∏°‡πà
      localStorage.setItem('token', access_token)
      localStorage.setItem('refresh_token', refresh_token)
      return access_token // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á access_token
    } catch (error) {
      console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä token ‡πÑ‡∏î‡πâ:', error)
      localStorage.removeItem('token')
      localStorage.removeItem('refresh_token')
      window.location.href = '/'
    }
  } else {
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö Refresh Token')
    window.location.href = '/'
  }
}

onMounted(async () => {
  await fetchUserData()
  console.log('Component mounted', book.value)
  // await Promise.all([fetchFaculties(), fetchDepartments()])
})

const stores = ref<string[]>([])
const roles = ['‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå', '‡∏ô‡∏¥‡∏™‡∏¥‡∏ï', '‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£', '‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏à‡∏±‡∏¢']
const couponUsed = ['‡∏°‡∏µ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á']
const faculties = ref<string[]>([])
const departments = ref<string[]>([])
</script>

<style scoped>
.header {
  display: flex;
  align-items: center;
  margin-bottom: 20px;
}

.header-image {
  width: 60px;
  height: auto;
  margin-right: 15px;
}

h1 {
  font-size: 24px;
  font-weight: bold;
  margin-bottom: 20px;
  margin: 0;
}

.v-container {
  margin-top: 20px;
}

/* ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô */
.form-row {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
  font-size: 20px;
  justify-content: space-between;
}

.form-row label {
  min-width: 120px; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
  margin-bottom: 10px;
  margin-right: 10px;
  font-weight: bold;
  text-align: center;
  justify-content: center;
  font-size: 20px;
}

.text-feild-top {
  margin-top: 2px;
  min-height: 50px;
  width: 100%;
  max-width: 500px;
}

.v-text-field,
.v-select {
  width: 100%; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà */
  max-width: 1000px;
  flex-grow: 1; /* ‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ */
}

.confirm-btn {
  color: black;
  font-size: 18px;
  font-weight: bold;
  text-align: center;
  justify-content: center;
  display: flex;
  align-items: center;
  margin-left: auto;
  transition: background-color 0.3s ease; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° transition ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢ */
}

.confirm-btnheight {
  width: 100px;
  height: 50px;
}

.dialog {
  width: 600px;
}

.btn-dialog {
  font-size: 16px;
  font-weight: bold; /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤ */
  border-radius: 25px; /* ‡∏Ç‡∏≠‡∏ö‡∏°‡∏ô */
  box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.3); /* ‡πÄ‡∏á‡∏≤ */
  background-color: #e0e6f0; /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏∏‡πà‡∏° */
  color: black; /* ‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ */
}

.v-radio-group {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
}

.v-radio {
  margin-right: 16px;
  font-size: 24px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
  color: black;
}

.custom-radio {
  font-size: 24px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
  color: black;
}

.text-radiio {
  font-weight: bold;
  font-size: 24px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
  color: black;
}

.required-asterisk {
  color: red;
  font-size: 16px;
  margin-left: 2px;
}

.text {
  font-size: 18px;
}

.gray-field {
  color: #666666; /* ‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏ó‡∏≤ */
  /* pointer-events: none; ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö */
}

.form-wrapper {
  max-width: 1000px;
  margin: 0 auto;
  padding: 20px;
  border-radius: 8px;
}

.form-grid {
  display: grid;
  grid-template-columns: 1fr; /* ‡πÅ‡∏™‡∏î‡∏á 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡πà‡∏≠‡πÅ‡∏ñ‡∏ß */
}

.form-item {
  display: flex;
  flex-direction: column;
}

.form-label {
  font-size: 16px;
  font-weight: bold;
  margin-bottom: 8px;
}

.form-input {
  width: 100%;
}

.form-actions {
  margin-top: 20px;
  display: flex;
  justify-content: flex-end;
}

.confirm-btn {
  background-color: #eed3d9;
  color: #fff;
  font-size: 16px;
  font-weight: bold;
  padding: 10px 20px;
  border-radius: 4px;
  transition: background-color 0.3s ease;
}

.confirm-btn:hover {
  background-color: #e5a1a8;
}

@media (max-width: 768px) {
  .form-grid {
    grid-template-columns: 1fr;
  }
}
</style>

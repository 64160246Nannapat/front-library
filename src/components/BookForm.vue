<template>
  <v-main style="height: 500px; margin-top: -60px">
    <!-- <HomeStudent /> -->
    <v-main>
      <v-container>
        <div class="header">
          <img class="header-image" src="@/assets/library (1).png" alt="Library Image" />
          <h1>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏ô‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</h1>
        </div>
        <v-form ref="bookForm" v-model="valid">
          <!-- ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠ -->
          <div class="form-row">
            <label for="name" style="font-size: 18px"
              >‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ <span class="required-asterisk">*</span></label
            >
            <v-text-field
              v-model="book.Prefix"
              :rules="[rules.required]"
              variant="outlined"
              class="text-feild-top text"
              dense
            ></v-text-field>
          </div>

          <!-- ‡∏ä‡∏∑‡πà‡∏≠ -->
          <div class="form-row">
            <label for="firstName" style="font-size: 18px"
              >‡∏ä‡∏∑‡πà‡∏≠<span class="required-asterisk">*</span></label
            >
            <v-text-field
              v-model="book.FirstName"
              :rules="[rules.required]"
              variant="outlined"
              class="text-feild-top"
              dense
            ></v-text-field>
          </div>

          <!-- ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• -->
          <div class="form-row">
            <label for="lastName" style="font-size: 18px"
              >‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•<span class="required-asterisk">*</span></label
            >
            <v-text-field
              v-model="book.LastName"
              :rules="[rules.required]"
              variant="outlined"
              class="text-feild-top"
              dense
            ></v-text-field>
          </div>

          <!-- ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á -->
          <div class="form-row">
            <label for="role" style="font-size: 18px"
              >‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á<span class="required-asterisk">*</span></label
            >
            <v-select
              v-model="book.Role"
              :items="roles"
              :rules="[rules.required]"
              variant="outlined"
              class="text-feild-top"
              dense
            ></v-select>
          </div>

          <!-- ‡∏Ñ‡∏ì‡∏∞ -->
          <div class="form-row">
            <label for="faculty" style="font-size: 18px"
              >‡∏Ñ‡∏ì‡∏∞<span class="required-asterisk">*</span></label
            >
            <v-select
              v-model="book.Faculty"
              :items="faculties"
              :rules="[rules.required]"
              variant="outlined"
              class="text-feild-top"
              dense
            ></v-select>
          </div>

          <!-- ‡∏™‡∏≤‡∏Ç‡∏≤ -->
          <div class="form-row">
            <label for="department" style="font-size: 18px"
              >‡∏™‡∏≤‡∏Ç‡∏≤<span class="required-asterisk">*</span></label
            >
            <v-select
              v-model="book.Department"
              :items="departments"
              :rules="[rules.required]"
              variant="outlined"
              class="text-feild-top"
              dense
            ></v-select>
          </div>

          <!-- ‡πÄ‡∏ö‡∏≠‡∏£‡πå -->
          <div class="form-row">
            <label for="tel" style="font-size: 18px"
              >‡πÄ‡∏ö‡∏≠‡∏£‡πå<span class="required-asterisk">*</span></label
            >
            <v-text-field
              v-model="book.Tel"
              :rules="[rules.required, rules.tel]"
              variant="outlined"
              class="text-feild-top"
              dense
            ></v-text-field>
          </div>

          <!-- E-mail -->
          <div class="form-row">
            <label for="email" style="font-size: 18px"
              >E-mail<span class="required-asterisk">*</span></label
            >
            <v-text-field
              v-model="book.Email"
              :rules="[rules.required, rules.email]"
              variant="outlined"
              class="text-feild-top"
              dense
            ></v-text-field>
          </div>

          <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (Dropdown) -->
          <div class="form-row">
            <label for="store" style="font-size: 18px"
              >‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤<span class="required-asterisk">*</span></label
            >
            <v-select
              v-model="book.Store"
              :items="stores"
              :rules="[rules.required]"
              variant="outlined"
              class="text-feild-top"
              dense
            ></v-select>
          </div>

          <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ -->
          <div class="form-row">
            <label for="title" style="font-size: 18px"
              >‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠<span class="required-asterisk">*</span></label
            >
            <v-text-field
              v-model="book.Title"
              :rules="[rules.required]"
              variant="outlined"
              class="text-feild-top"
              dense
            ></v-text-field>
          </div>

          <!-- ‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á -->
          <div class="form-row">
            <label for="author" style="font-size: 18px">‡∏ú‡∏π‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡πà‡∏á</label>
            <v-text-field
              v-model="book.Author"
              variant="outlined"
              class="text-feild-top"
              dense
            ></v-text-field>
          </div>

          <!-- ‡∏õ‡∏µ‡∏û‡∏¥‡∏°‡∏û‡πå -->
          <div class="form-row">
            <label for="year" style="font-size: 18px">‡∏õ‡∏µ‡∏û‡∏¥‡∏°‡∏û‡πå</label>
            <v-text-field
              v-model="book.Year"
              variant="outlined"
              class="text-feild-top"
              dense
            ></v-text-field>
          </div>

          <!-- ISBN -->
          <div class="form-row">
            <label for="isbn" style="font-size: 18px"
              >ISBN<span class="required-asterisk">*</span></label
            >
            <v-text-field
              v-model="book.isbn"
              :rules="[rules.required, rules.isbn]"
              variant="outlined"
              class="text-feild-top"
              dense
            ></v-text-field>
          </div>

          <!-- ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ -->
          <div class="form-row">
            <label for="subject" style="font-size: 18px"
              >‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤<span class="required-asterisk">*</span></label
            >
            <v-text-field
              v-model="book.Subject"
              :rules="[rules.required]"
              variant="outlined"
              class="text-feild-top"
              dense
            ></v-text-field>
          </div>

          <!-- ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ -->
          <div class="form-row">
            <label for="price" style="font-size: 18px"
              >‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥<span class="required-asterisk">*</span></label
            >
            <v-text-field
              v-model="book.Price"
              :rules="[rules.required, rules.number]"
              variant="outlined"
              class="text-feild-top"
              dense
            ></v-text-field>
          </div>

          <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏•‡πà‡∏° -->
          <div class="form-row">
            <label for="count" style="font-size: 18px"
              >‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏•‡πà‡∏°<span class="required-asterisk">*</span></label
            >
            <v-text-field
              v-model="book.Count"
              :rules="[rules.required, rules.number]"
              variant="outlined"
              class="text-feild-top"
              dense
            ></v-text-field>
          </div>

          <!-- ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á -->
          <div class="form-row">
            <label for="coupon" style="font-size: 18px"
              >‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á<span class="required-asterisk">*</span></label
            >
            <v-select
              v-model="book.Coupon"
              :items="couponUsed"
              :rules="[rules.required]"
              variant="outlined"
              class="text-feild-top"
              dense
            ></v-select>
          </div>

          <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô -->
          <v-btn
            :disabled="!valid"
            elevation="8"
            class="mt-4 confirm-btn confirm-btnheight"
            style="background-color: #eed3d9"
            @click="submitForm"
          >
            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
          </v-btn>
        </v-form>
        <!-- dialog ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•-->
        <v-dialog v-model="dialog" max-width="400px">
          <v-card class="dialog">
            <v-card-title class="text-center" style="font-weight: bold; font-size: 22px">
              üéâ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!
            </v-card-title>
            <v-card-text class="text-center" style="font-size: 18px">
              ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
            </v-card-text>
            <v-card-actions justify-center>
              <v-btn class="btn-dialog" @click="confirmReset(bookForm)"> ‡∏ï‡∏Å‡∏•‡∏á </v-btn>
            </v-card-actions>
          </v-card>
        </v-dialog>
      </v-container>
    </v-main>
  </v-main>
</template>

<script setup lang="ts">
import axios from 'axios'
import { onMounted, ref } from 'vue'
import { jwtDecode } from 'jwt-decode'
import type { VForm } from 'vuetify/components'

// import type Coupon from './Coupon.vue'

const bookForm = ref<VForm | null>(null)
const submitted = ref(false)
const valid = ref(false) //‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö v-form
const dialog = ref(false)
const book = ref({
  Prefix: '',
  FirstName: '',
  LastName: '',
  Role: '',
  Faculty: '',
  Department: '',
  Tel: '',
  Email: '',
  Store: '',
  Title: '',
  Author: '',
  Year: '',
  isbn: '',
  Subject: '',
  Price: '',
  Count: '',
  Coupon: '',
  User: '',
})

const user = ref({
  Prefix: '',
  FirstName: '',
  LastName: '',
  Role: '',
  Faculty: '',
  Department: '',
  Tel: '',
  Email: '',
  User: '',
})

const rules = {
  required: (value: string) => {
    return !value ? '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : true
  },
  email: (value: string) =>
    /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(value) || '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
  tel: (value: string) => /^[0-9]{9,10}$/.test(value) || '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 9 - 10 ‡∏´‡∏•‡∏±‡∏Å',
  isbn: (value: string) => /^(97(8|9))?\d{9}(\d|X)$/.test(value) || '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ISBN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
  number: (value: string) => /^[0-9]+(\.[0-9]+)?$/.test(value) || '‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
  radio: (value) => !!value || '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å',
}

// const submitForm = async () => {
//   const form = bookForm.value // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á bookForm ‡∏à‡∏≤‡∏Å ref
//   if (form && typeof form.validate === 'function') {
//     const { valid } = await form.validate() // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å validate()

//     if (valid) {
//       try {
//         const formData = {
//           user_fullname: book.value.Prefix + ' ' + book.value.FirstName + ' ' + book.value.LastName,
//           user_name: book.value.FirstName,
//           role_id: Number(book.value.Role),
//           user_email: book.value.Email,
//           user_tel: book.value.Tel,
//           faculty_id: Number(book.value.Faculty),
//           department_id: book.value.Department,
//           store_id: stores.value.indexOf(book.value.Store) + 1,
//           book_title: book.value.Title,
//           book_author: book.value.Author,
//           book_subject: book.value.Subject,
//           published_year: Number(book.value.Year),
//           ISBN: book.value.isbn,
//           book_price: Number(book.value.Price),
//           book_quantity: Number(book.value.Count),
//           user_id: book.value.User ? Number(book.value.User) : null,
//           coupon_used: book.value.Coupon,
//         }

//         const response = await axios.post('http://localhost:3000/offer-form', formData, {
//           headers: {
//             'Content-Type': 'application/json',
//             Authorization: `Bearer ${localStorage.getItem('token')}`,
//           },
//         })

//         console.log('Response:', response.data)
//         submitted.value = true
//         dialog.value = true
//       } catch (error) {
//         console.error('Error submitting form:', error)
//         if (error.response && error.response.data) {
//           console.log('User ID:', book.value.User)
//           console.error('API Error:', error.response.data.message)
//         }
//       }
//     } else {
//       console.log('Validation Failed')
//     }
//   } else {
//     console.error('Form reference is invalid or validate is not a function')
//   }
// }

const fetchUserData = async () => {
  const token = localStorage.getItem('token');

  if (!token) {
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
    window.location.href = '/';
    return;
  }

  try {
    let userId = null;
    const decoded: any = isTokenExpired(token)
      ? await refreshAndDecodeToken()
      : jwtDecode(token);

    if (decoded) {
      userId = decoded.sub; // ‡∏î‡∏∂‡∏á user_id ‡∏à‡∏≤‡∏Å sub ‡πÉ‡∏ô token
      user.value.Prefix = decoded.prefix;
      user.value.FirstName = decoded.firstName;
      user.value.LastName = decoded.lastName;
      user.value.Role = decoded.offer_position;
      user.value.Faculty = decoded.faculty;
      user.value.Department = decoded.department;
      user.value.Tel = decoded.tel;
      user.value.Email = decoded.email;
      user.value.User = userId; // ‡πÄ‡∏Å‡πá‡∏ö user_id ‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤
    }

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö book
    book.value.Prefix = user.value.Prefix;
    book.value.FirstName = user.value.FirstName;
    book.value.LastName = user.value.LastName;
    book.value.Role = user.value.Role;
    book.value.Faculty = user.value.Faculty;
    book.value.Department = user.value.Department;
    book.value.Tel = user.value.Tel;
    book.value.Email = user.value.Email;
    book.value.User = user.value.User;

  } catch (error) {
    console.error('Token decoding error:', error);
  }
};

const submitForm = async () => {
  const form = bookForm.value; // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á bookForm ‡∏à‡∏≤‡∏Å ref
  if (form && typeof form.validate === 'function') {
    const { valid } = await form.validate(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å validate()

    if (valid) {
      try {
        const formData = {
          user_fullname: `${book.value.Prefix} ${book.value.FirstName} ${book.value.LastName}`,
          user_name: book.value.FirstName,
          role_id: Number(book.value.Role),
          user_email: book.value.Email,
          user_tel: book.value.Tel,
          faculty_id: Number(book.value.Faculty),
          department_id: book.value.Department,
          store_id: stores.value.indexOf(book.value.Store) + 1,
          book_title: book.value.Title,
          book_author: book.value.Author,
          book_subject: book.value.Subject,
          published_year: Number(book.value.Year),
          ISBN: book.value.isbn,
          book_price: Number(book.value.Price),
          book_quantity: Number(book.value.Count),
          user_id: book.value.User ? Number(book.value.User) : null, // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö user_id
          coupon_used: book.value.Coupon,
        };

        const response = await axios.post('http://localhost:3000/offer-form', formData, {
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${localStorage.getItem('token')}`,
          },
        });

        console.log('Response:', response.data);
        submitted.value = true;
        dialog.value = true;
      } catch (error) {
        console.error('Error submitting form:', error);
        if (error.response && error.response.data) {
          console.log('User ID:', book.value.User);
          console.error('API Error:', error.response.data.message);
        }
      }
    } else {
      console.log('Validation Failed');
    }
  } else {
    console.error('Form reference is invalid or validate is not a function');
  }
};

// Helper function
const refreshAndDecodeToken = async () => {
  try {
    const newAccessToken = await refreshToken();
    return jwtDecode(newAccessToken);
  } catch (error) {
    console.error('Error refreshing token:', error);
    return null;
  }
};


const confirmReset = (bookForm: any) => {
  dialog.value = false // ‡∏õ‡∏¥‡∏î Dialog
  resetForm(bookForm) // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏î "‡∏ï‡∏Å‡∏•‡∏á"
}

const resetForm = (bookForm: any) => {
  book.value = {
    Prefix: '',
    FirstName: '',
    LastName: '',
    Role: '',
    Faculty: '',
    Department: '',
    Tel: '',
    Email: '',
    Store: '',
    Title: '',
    Author: '',
    Year: '',
    isbn: '',
    Subject: '',
    Price: '',
    Count: '',
  }

  bookForm.reset() // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï v-form
  submitted.value = false
}

const fetchStores = async () => {
  try {
    const response = await axios.get('http://localhost:3000/store')
    console.log('Response data:', response.data) // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
    stores.value = response.data.map((store: any) => store.store_name) // ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  } catch (error) {
    console.error('Error fetching stores:', error)
  }
}

// const fetchRoles = async () => {
//   try {
//     const response = await axios.get('http://localhost:3000/role')
//     console.log('Response data:', response.data)

//     const groupedRoles = {
//       ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå: response.data.filter((role: any) =>
//         ['Teacher', 'StaffFaculty'].includes(role.role_name),
//       ),
//       ‡∏ô‡∏¥‡∏™‡∏¥‡∏ï: response.data.filter((role: any) => role.role_name === 'Student'),
//       ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£: response.data.filter((role: any) =>
//         ['StaffLibrary', 'Executive'].includes(role.role_name),
//       ),
//     }

//     console.log('Grouped Roles:', groupedRoles)
//     roles.value = Object.keys(groupedRoles) // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö `v-select`
//   } catch (error) {
//     console.error('Error fetching roles:', error)
//   }
// }

const fetchFaculties = async () => {
  try {
    const response = await axios.get('http://localhost:3000/faculty')
    console.log('Response data:', response.data) // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
    faculties.value = response.data.map((faculty: any) => faculty.faculty_name)
  } catch (error) {
    console.error('Error fetching faculties:', error)
  }
}

const fetchDepartments = async () => {
  try {
    const response = await axios.get('http://localhost:3000/department')
    console.log('Response data:', response.data) // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
    departments.value = response.data.map((department: any) => department.department_name)
  } catch (error) {
    console.error('Error fetching departments:', error)
  }
}

const isTokenExpired = (token: string) => {
  const decoded: any = jwtDecode(token)
  const currentTime = Date.now() / 1000 // Convert to seconds
  return decoded.exp < currentTime // Compare expiration time
}

const refreshToken = async () => {
  const refreshToken = localStorage.getItem('refresh_token')
  if (refreshToken) {
    try {
      const response = await axios.post('http://localhost:3000/auth/refresh', { refreshToken })
      const { access_token, refresh_token } = response.data
      // ‡πÄ‡∏Å‡πá‡∏ö Access Token ‡πÅ‡∏•‡∏∞ Refresh Token ‡πÉ‡∏´‡∏°‡πà
      localStorage.setItem('token', access_token)
      localStorage.setItem('refresh_token', refresh_token)
      return access_token // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á access_token
    } catch (error) {
      console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä token ‡πÑ‡∏î‡πâ:', error)
      localStorage.removeItem('token')
      localStorage.removeItem('refresh_token')
      window.location.href = '/'
    }
  } else {
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö Refresh Token')
    window.location.href = '/'
  }
}

// const fetchUserData = async () => {
//   const token = localStorage.getItem('token')

//   if (!token) {
//     alert('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà')
//     window.location.href = '/'
//     return
//   }

//   try {
//     let userId = null
//     if (isTokenExpired(token)) {
//       // ‡∏ñ‡πâ‡∏≤ Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏î‡πâ‡∏ß‡∏¢ Refresh Token
//       const newAccessToken = await refreshToken()
//       if (newAccessToken) {
//         const decoded: any = jwtDecode(newAccessToken)
//         userId = decoded.sub // ‡∏î‡∏∂‡∏á user_id ‡∏à‡∏≤‡∏Å sub ‡πÉ‡∏ô token
//         user.value.Prefix = decoded.prefix
//         user.value.FirstName = decoded.firstName
//         user.value.LastName = decoded.lastName
//         user.value.Role = decoded.offer_position
//         user.value.Faculty = decoded.faculty
//         user.value.Department = decoded.department
//         user.value.Tel = decoded.tel
//         user.value.Email = decoded.email
//         user.value.User = userId // ‡πÄ‡∏Å‡πá‡∏ö user_id ‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤
//       }
//     } else {
//       const decoded: any = jwtDecode(token)
//       userId = decoded.sub // ‡∏î‡∏∂‡∏á user_id ‡∏à‡∏≤‡∏Å sub ‡πÉ‡∏ô token
//       user.value.Prefix = decoded.prefix
//       user.value.FirstName = decoded.firstName
//       user.value.LastName = decoded.lastName
//       user.value.Role = decoded.offer_position
//       user.value.Faculty = decoded.faculty
//       user.value.Department = decoded.department
//       user.value.Tel = decoded.tel
//       user.value.Email = decoded.email
//       user.value.User = userId // ‡πÄ‡∏Å‡πá‡∏ö user_id ‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤
//     }

//     // ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö book
//     book.value.Prefix = user.value.Prefix
//     book.value.FirstName = user.value.FirstName
//     book.value.LastName = user.value.LastName
//     book.value.Role = user.value.Role
//     book.value.Faculty = user.value.Faculty
//     book.value.Department = user.value.Department
//     book.value.Tel = user.value.Tel
//     book.value.Email = user.value.Email
//     user.value.User = user.value.User
//   } catch (error) {
//     console.error('Token decoding error:', error)
//   }
// }

onMounted(async () => {
  await fetchUserData()
  console.log('Component mounted')
  await Promise.all([
    fetchStores(),
    // fetchRoles(),
    fetchFaculties(),
    fetchDepartments(),
  ])
})

const stores = ref<string[]>([])
const roles = ['‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå', '‡∏ô‡∏¥‡∏™‡∏¥‡∏ï', '‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£', '‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏à‡∏±‡∏¢']
const couponUsed = ['‡∏°‡∏µ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á']
const faculties = ref<string[]>([])
const departments = ref<string[]>([])
</script>

<style scoped>
.header {
  display: flex;
  align-items: center;
  margin-bottom: 20px;
}

.header-image {
  width: 60px;
  height: auto;
  margin-right: 15px;
}

h1 {
  font-size: 24px;
  font-weight: bold;
  margin-bottom: 20px;
  margin: 0;
}

.v-container {
  margin-top: 20px;
}

/* ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô */
.form-row {
  display: flex;
  align-items: center;
  margin-bottom: 16px;
  font-size: 20px;
  justify-content: space-between;
}

.form-row label {
  min-width: 120px; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
  margin-right: 10px;
  font-weight: bold;
  text-align: center;
  justify-content: center;
  font-size: 20px;
}

.text-feild-top {
  margin-top: 20px;
  min-height: 50px;
}

.v-text-field,
.v-select {
  flex-grow: 1; /* ‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ */
}

.confirm-btn {
  font-size: 20px;
  font-weight: bold;
  text-align: center;
  justify-content: center;
  display: flex;
  align-items: center;
  margin-left: auto;
  transition: background-color 0.3s ease; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° transition ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢ */
}

.confirm-btnheight {
  width: 150px;
  height: 50px;
}

.dialog {
  background-color: #eed3d9;
}

.btn-dialog {
  font-size: 16px;
  font-weight: bold; /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤ */
  border-radius: 25px; /* ‡∏Ç‡∏≠‡∏ö‡∏°‡∏ô */
  box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.3); /* ‡πÄ‡∏á‡∏≤ */
  background-color: #e0e6f0; /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏∏‡πà‡∏° */
  color: black; /* ‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ */
}

.v-radio-group {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
}

.v-radio {
  margin-right: 16px;
  font-size: 24px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
  color: black;
}

.custom-radio {
  font-size: 24px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
  color: black;
}

.text-radiio {
  font-weight: bold;
  font-size: 24px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
  color: black;
}

.required-asterisk {
  color: red;
  font-size: 16px;
  margin-left: 2px;
}

.text {
  font-size: 18px;
}
</style>
